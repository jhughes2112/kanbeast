<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>KanBeast - AI-Driven Kanban Board</title>
	<style>
		/* Inline minimal loading screen so it renders even if styles.css hasn't loaded yet */
		body.loading {
			background: #09090b;
			color: #d4d4d8;
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			display: flex;
			align-items: center;
			justify-content: center;
			min-height: 100vh;
			margin: 0;
		}
		#loadingScreen {
			text-align: center;
		}
		#loadingScreen .spinner-load {
			width: 32px;
			height: 32px;
			border: 3px solid #3f3f46;
			border-top-color: #0ea5e9;
			border-radius: 50%;
			animation: spin-load 0.8s linear infinite;
			margin: 0 auto 1rem;
		}
		@keyframes spin-load { to { transform: rotate(360deg); } }
		#loadingScreen p { font-size: 0.875rem; color: #71717a; }
		body.loading header,
		body.loading main,
		body.loading .modal { display: none !important; }
	</style>
</head>
<body class="loading">
	<header>
		<h1>
			<img src="kanbeast.png" alt="KanBeast Logo" class="logo-icon">
			<img src="kanbeast.jpg" alt="KanBeast" class="logo-text">
		</h1>
		<nav>
			<div id="connectionStatus" class="connecting">
				<span class="status-dot"></span>
				<span id="connectionText">Connecting...</span>
			</div>
			<button id="settingsBtn" class="btn-secondary">‚öôÔ∏è Settings</button>
		</nav>
	</header>

	<main id="kanbanBoard">
		<div class="column" data-status="Backlog">
			<div class="column-header">
				<h2>üìã Backlog</h2>
				<button id="newTicketBtn" class="btn-primary btn-sm">+ New</button>
				<span class="count" id="backlog-count">0</span>
			</div>
			<div class="ticket-container" id="backlog-container"></div>
		</div>
		<div class="column" data-status="Active">
			<div class="column-header">
				<h2>üöÄ Active</h2>
				<span class="count" id="active-count">0</span>
			</div>
			<div class="ticket-container" id="active-container"></div>
		</div>
		<div class="column" data-status="Failed">
			<div class="column-header">
				<h2>‚ùå Failed</h2>
				<span class="count" id="failed-count">0</span>
			</div>
			<div class="ticket-container" id="failed-container"></div>
		</div>
		<div class="column" data-status="Done">
			<div class="column-header">
				<h2>‚úÖ Done</h2>
				<span class="count" id="done-count">0</span>
			</div>
			<div class="ticket-container" id="done-container"></div>
		</div>
	</main>

	<!-- New Ticket Modal -->
	<div id="newTicketModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>Create New Ticket</h2>
				<button class="close" aria-label="Close">&times;</button>
			</div>
			<form id="newTicketForm">
				<div class="form-group">
					<label for="ticketTitle">Title</label>
					<input type="text" id="ticketTitle" placeholder="Enter a descriptive title..." required>
				</div>
				<div class="form-group">
					<label for="ticketDescription">Description</label>
					<textarea id="ticketDescription" rows="4" placeholder="Describe what needs to be done..." required></textarea>
				</div>
				<div class="form-group">
					<label for="ticketMaxCost">Max Cost ($)</label>
					<input type="number" id="ticketMaxCost" min="0" step="0.01" placeholder="0.00 = unlimited">
					<small style="color: var(--gray-500);">Maximum LLM spend for this ticket. 0 = no limit.</small>
				</div>
				<button type="submit" class="btn-primary" style="width: 100%;">Create Ticket</button>
			</form>
		</div>
	</div>

	<!-- Ticket Detail Modal -->
	<div id="ticketDetailModal" class="modal">
		<div class="modal-content detail-modal-content">
			<div class="modal-header">
				<h2 id="detailTitle">Ticket Details</h2>
			</div>
			<div id="ticketDetail" class="detail-panes"></div>
			<div id="ticketDetailActions" class="ticket-actions"></div>
			<div class="detail-resize-handle" id="detailResizeHandle">‚ü°</div>
		</div>
	</div>

	<!-- Chat Modal -->
	<div id="chatModal" class="modal">
		<div class="modal-content chat-modal-content">
			<div class="modal-header chat-modal-header">
				<h2 id="chatTitle">üí¨ Conversations</h2>
				<div id="chatConversationPicker" class="chat-conversation-picker"></div>
				<button class="close" id="chatCloseBtn" aria-label="Close">&times;</button>
			</div>
			<div id="chatInfoBar" class="chat-info-bar" style="display:none;"></div>
			<div id="chatMessages" class="chat-messages"></div>
			<div class="chat-input-area">
				<textarea id="chatInput" class="chat-input" placeholder="Select a conversation‚Ä¶" rows="1" disabled></textarea>
				<button id="chatStopBtn" class="btn-danger chat-stop-btn" title="Stop" onclick="interruptConversation()">‚ñ†</button>
				<button id="chatSendBtn" class="btn-primary chat-send-btn" disabled>‚Üí</button>
			</div>
		</div>
	</div>

	<!-- Settings Modal -->
	<div id="settingsModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>Settings</h2>
				<button class="close" aria-label="Close">&times;</button>
			</div>
			<div id="settingsContent">
				<div class="accordion collapsed">
					<div class="accordion-header" data-accordion="llm-section">
						<span>ü§ñ LLM Configurations</span>
						<span class="accordion-icon">‚ñº</span>
					</div>
					<div class="accordion-content" id="llm-section">
						<div id="llmConfigs"></div>
						<button id="addLLMBtn" class="btn-secondary" type="button">+ Add LLM Configuration</button>
					</div>
				</div>

				<div class="accordion collapsed">
					<div class="accordion-header" data-accordion="compaction-section">
						<span>üì¶ Compaction Settings</span>
						<span class="accordion-icon">‚ñº</span>
					</div>
					<div class="accordion-content" id="compaction-section">
						<div class="form-group">
							<label for="compactionType">Compaction Type</label>
							<select id="compactionType">
								<option value="disabled">Disabled</option>
								<option value="summarize">Summarize</option>
							</select>
						</div>
						<div id="compactionOptions" class="compaction-options" style="display: none;">
							<div class="form-group">
								<label for="contextPercent">Context Size Percent: <span id="contextPercentValue">90%</span></label>
								<input type="range" id="contextPercent" min="10" max="95" step="5" value="90" oninput="updatePercentLabel()">
								<small style="color: var(--gray-500);">Compaction triggers when context reaches this % of LLM limit.</small>
							</div>
						</div>
					</div>
				</div>

				<div class="accordion collapsed">
					<div class="accordion-header" data-accordion="git-section">
						<span>üåø Git Configuration</span>
						<span class="accordion-icon">‚ñº</span>
					</div>
					<div class="accordion-content" id="git-section">
						<form id="gitConfigForm">
							<div class="form-group">
								<label for="gitUsername">Username</label>
								<input type="text" id="gitUsername" placeholder="used for git commits, can be anything">
							</div>
							<div class="form-group">
								<label for="gitEmail">Email</label>
								<input type="email" id="gitEmail" placeholder="used for git commits, can be anything">
							</div>
							<div class="form-group">
								<label for="gitUrl">Repository URL</label>
								<input type="text" id="gitUrl" placeholder="https://github.com/user/repo.git or git@github.com:user/repo.git">
							</div>
							<div style="display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0; color: var(--gray-600); font-weight: 600; font-size: 0.875rem;">
								<div style="flex: 1; height: 1px; background: var(--gray-300);"></div>
								<span>Authentication Method</span>
								<div style="flex: 1; height: 1px; background: var(--gray-300);"></div>
							</div>
							<div class="form-group">
								<label for="gitApiToken">API Token</label>
								<input type="password" id="gitApiToken" placeholder="ghp_xxxx or glpat-xxxx">
								<small style="color: var(--gray-500);">Preferred for HTTPS URLs.</small>
							</div>
							<div class="form-group">
								<label for="gitPassword">Password</label>
								<input type="password" id="gitPassword" placeholder="Only if not using API token.">
							</div>
							<div class="form-group">
								<label for="gitSshKey">SSH Private Key</label>
								<textarea id="gitSshKey" rows="4" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"></textarea>
								<small style="color: var(--gray-500);">For SSH URLs only.</small>
							</div>
						</form>
					</div>
				</div>

						</div>
					</div>
				</div>

	<script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
	<div id="loadingScreen">
		<div class="spinner-load"></div>
		<p id="loadingStatus">Waiting for server...</p>
	</div>
	<script>
		// Dynamic resource loader with retry for server startup delays.
		async function waitForServer(maxRetries = 30) {
			for (let attempt = 1; attempt <= maxRetries; attempt++) {
				try {
					const response = await fetch('/styles.css', { cache: 'no-store' });
					if (response.ok) {
						return true;
					}
				} catch (e) {
					// Server not up yet.
				}

				document.getElementById('loadingStatus').textContent = `Waiting for server... (${attempt}/${maxRetries})`;
				const delay = Math.min(500 * Math.pow(1.3, attempt - 1), 5000);
				await new Promise(resolve => setTimeout(resolve, delay));
			}

			return false;
		}

		function loadStylesheet(href) {
			const link = document.createElement('link');
			link.rel = 'stylesheet';
			link.href = href + '?v=' + Date.now();
			document.head.appendChild(link);
		}

		async function loadScript(src) {
			const response = await fetch(src + '?v=' + Date.now(), { cache: 'no-store' });
			if (!response.ok) {
				throw new Error(`Failed to fetch ${src}: ${response.status}`);
			}

			const code = await response.text();
			const script = document.createElement('script');
			script.textContent = code;
			document.body.appendChild(script);
			console.log(`‚úì Loaded ${src}`);
		}

		(async () => {
			const serverReady = await waitForServer();
			if (!serverReady) {
				document.getElementById('loadingStatus').textContent = 'Server unavailable. Please refresh.';
				return;
			}

			try {
				loadStylesheet('/styles.css');
				await loadScript('/app.js');
				document.body.classList.remove('loading');
				document.getElementById('loadingScreen').remove();

				if (typeof init === 'function') {
					init();
				}
			} catch (error) {
				console.error('Failed to load application:', error);
				document.getElementById('loadingStatus').textContent = 'Failed to load. Please refresh.';
			}
		})();
	</script>
</body>
</html>
