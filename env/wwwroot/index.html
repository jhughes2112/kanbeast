<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>KanBeast - AI-Driven Kanban Board</title>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
	<header>
		<h1>
			<img src="kanbeast.png" alt="KanBeast Logo" class="logo-icon">
			<img src="kanbeast.jpg" alt="KanBeast" class="logo-text">
		</h1>
		<nav>
			<div id="connectionStatus" class="connecting">
				<span class="status-dot"></span>
				<span id="connectionText">Connecting...</span>
			</div>
			<button id="settingsBtn" class="btn-secondary">‚öôÔ∏è Settings</button>
		</nav>
	</header>

	<main id="kanbanBoard">
		<div class="column" data-status="Backlog">
			<div class="column-header">
				<h2>üìã Backlog</h2>
				<button id="newTicketBtn" class="btn-primary btn-sm">+ New</button>
				<span class="count" id="backlog-count">0</span>
			</div>
			<div class="ticket-container" id="backlog-container"></div>
		</div>
		<div class="column" data-status="Active">
			<div class="column-header">
				<h2>üöÄ Active</h2>
				<span class="count" id="active-count">0</span>
			</div>
			<div class="ticket-container" id="active-container"></div>
		</div>
		<div class="column" data-status="Failed">
			<div class="column-header">
				<h2>‚ùå Failed</h2>
				<span class="count" id="failed-count">0</span>
			</div>
			<div class="ticket-container" id="failed-container"></div>
		</div>
		<div class="column" data-status="Done">
			<div class="column-header">
				<h2>‚úÖ Done</h2>
				<span class="count" id="done-count">0</span>
			</div>
			<div class="ticket-container" id="done-container"></div>
		</div>
	</main>

	<!-- New Ticket Modal -->
	<div id="newTicketModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>Create New Ticket</h2>
				<button class="close" aria-label="Close">&times;</button>
			</div>
			<form id="newTicketForm">
				<div class="form-group">
					<label for="ticketTitle">Title</label>
					<input type="text" id="ticketTitle" placeholder="Enter a descriptive title..." required>
				</div>
				<div class="form-group">
					<label for="ticketDescription">Description</label>
					<textarea id="ticketDescription" rows="4" placeholder="Describe what needs to be done..." required></textarea>
				</div>
				<div class="form-group">
					<label for="ticketMaxCost">Max Cost ($)</label>
					<input type="number" id="ticketMaxCost" min="0" step="0.01" placeholder="0.00 = unlimited">
					<small style="color: var(--gray-500);">Maximum LLM spend for this ticket. 0 = no limit.</small>
				</div>
				<button type="submit" class="btn-primary" style="width: 100%;">Create Ticket</button>
			</form>
		</div>
	</div>

	<!-- Ticket Detail Modal -->
	<div id="ticketDetailModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="detailTitle">Ticket Details</h2>
			</div>
			<div id="ticketDetail"></div>
		</div>
	</div>

	<!-- Settings Modal -->
	<div id="settingsModal" class="modal">
		<div class="modal-content">
			<div class="modal-header">
				<h2>Settings</h2>
				<button class="close" aria-label="Close">&times;</button>
			</div>
			<div id="settingsContent">
				<div class="accordion collapsed">
					<div class="accordion-header" data-accordion="llm-section">
						<span>ü§ñ LLM Configurations</span>
						<span class="accordion-icon">‚ñº</span>
					</div>
					<div class="accordion-content" id="llm-section">
						<div id="llmConfigs"></div>
						<button id="addLLMBtn" class="btn-secondary" type="button">+ Add LLM Configuration</button>
					</div>
				</div>

				<div class="accordion collapsed">
					<div class="accordion-header" data-accordion="worker-section">
						<span>‚öôÔ∏è Worker Settings</span>
						<span class="accordion-icon">‚ñº</span>
					</div>
					<div class="accordion-content" id="worker-section">
						<div class="form-group">
							<label class="checkbox-label">
								<input type="checkbox" id="jsonLogging">
								<span>Enable JSON Logging</span>
							</label>
							<small style="color: var(--gray-500);">Save conversation logs as JSON files for debugging.</small>
						</div>
					</div>
				</div>

				<div class="accordion collapsed">
					<div class="accordion-header" data-accordion="compaction-section">
						<span>üì¶ Compaction Settings</span>
						<span class="accordion-icon">‚ñº</span>
					</div>
					<div class="accordion-content" id="compaction-section">
						<div class="form-group">
							<label for="compactionType">Compaction Type</label>
							<select id="compactionType">
								<option value="disabled">Disabled</option>
								<option value="summarize">Summarize</option>
							</select>
						</div>
						<div id="compactionOptions" class="compaction-options" style="display: none;">
							<div class="form-group">
								<label for="contextPercent">Context Size Percent: <span id="contextPercentValue">90%</span></label>
								<input type="range" id="contextPercent" min="10" max="95" step="5" value="90" oninput="updatePercentLabel()">
								<small style="color: var(--gray-500);">Compaction triggers when context reaches this % of LLM limit.</small>
							</div>
						</div>
					</div>
				</div>

				<div class="accordion collapsed">
					<div class="accordion-header" data-accordion="git-section">
						<span>üåø Git Configuration</span>
						<span class="accordion-icon">‚ñº</span>
					</div>
					<div class="accordion-content" id="git-section">
						<form id="gitConfigForm">
							<div class="form-group">
								<label for="gitUsername">Username</label>
								<input type="text" id="gitUsername" placeholder="used for git commits, can be anything">
							</div>
							<div class="form-group">
								<label for="gitEmail">Email</label>
								<input type="email" id="gitEmail" placeholder="used for git commits, can be anything">
							</div>
							<div class="form-group">
								<label for="gitUrl">Repository URL</label>
								<input type="text" id="gitUrl" placeholder="https://github.com/user/repo.git or git@github.com:user/repo.git">
							</div>
							<div style="display: flex; align-items: center; gap: 1rem; margin: 1.5rem 0; color: var(--gray-600); font-weight: 600; font-size: 0.875rem;">
								<div style="flex: 1; height: 1px; background: var(--gray-300);"></div>
								<span>Authentication Method</span>
								<div style="flex: 1; height: 1px; background: var(--gray-300);"></div>
							</div>
							<div class="form-group">
								<label for="gitApiToken">API Token</label>
								<input type="password" id="gitApiToken" placeholder="ghp_xxxx or glpat-xxxx">
								<small style="color: var(--gray-500);">Preferred for HTTPS URLs.</small>
							</div>
							<div class="form-group">
								<label for="gitPassword">Password</label>
								<input type="password" id="gitPassword" placeholder="Only if not using API token.">
							</div>
							<div class="form-group">
								<label for="gitSshKey">SSH Private Key</label>
								<textarea id="gitSshKey" rows="4" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----"></textarea>
								<small style="color: var(--gray-500);">For SSH URLs only.</small>
							</div>
						</form>
					</div>
				</div>

				<button type="button" class="btn-primary" style="width: 100%; margin-top: 1rem;" onclick="saveSettings()">Save Settings</button>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
	<script>
		// Dynamic script loader with retry logic to handle server startup delays
		async function loadScript(src, maxRetries = 20) {
			for (let attempt = 1; attempt <= maxRetries; attempt++) {
				try {
					const response = await fetch(src);
					if (response.ok) {
						const code = await response.text();
						const script = document.createElement('script');
						script.textContent = code;
						document.body.appendChild(script);
						console.log(`‚úì Loaded ${src}`);
						return true;
					}
				} catch (error) {
					console.warn(`Attempt ${attempt}/${maxRetries} to load ${src} failed:`, error.message);
				}

				if (attempt < maxRetries) {
					const delay = Math.min(1000 * Math.pow(1.5, attempt - 1), 10000);
					await new Promise(resolve => setTimeout(resolve, delay));
				}
			}

			console.error(`‚úó Failed to load ${src} after ${maxRetries} attempts`);
			document.body.innerHTML = '<div style="padding: 2rem; text-align: center; color: #e53e3e;"><h1>Failed to load application</h1><p>Server may be unavailable. Please refresh the page.</p></div>';
			return false;
		}

		// Load app.js and initialize the app
		(async () => {
			if (await loadScript('/app.js')) {
				// DOMContentLoaded already fired, manually call init
				if (typeof init === 'function') {
					init();
				}
			}
		})();
	</script>
</body>
</html>
